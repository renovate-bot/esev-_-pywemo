name: Publish
on:
  release:
    types: [published]

permissions: {}  # No permissions by default. Permissions are added per-job.

env:
  # Artifact name to use for the release. The build matrix builds and tests
  # multiple Python versions. But the release only comes from this single
  # version.
  DIST_ARTIFACT: dist-3.10

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build.yml

  check:
    name: Check version and tag match
    runs-on: ubuntu-latest
    needs: build
    outputs:
      version: ${{ steps.outputs.outputs.version }}
      artifact: ${{ steps.outputs.outputs.artifact }}
    steps:
      - name: Set Outputs
        id: outputs
        run: |
          echo "artifact=dist-files-3.10" | tee -a "$GITHUB_OUTPUT"
          echo "version=$GITHUB_REF_NAME" | tee -a "$GITHUB_OUTPUT"
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ steps.outputs.outputs.artifact }}
          path: dist
      - name: Check if tag version matches project version
        working-directory: dist
        run: |
          # Get the version from the PKG-INFO in the source package.
          tar -xzf *.tar.gz
          DIST_VERSION=$(sed -ne 's/^Version: \([0-9]\..*\)$/\1/p' < */PKG-INFO | head -1)
          echo "TAG: $GITHUB_REF_NAME"
          echo "VERSION: $DIST_VERSION"
          if [[ "$GITHUB_REF_NAME" != "$DIST_VERSION" ]]; then exit 1; fi

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: check
    environment: release
    permissions:
      id-token: write # For PyPI trusted publishing
      contents: write # Adding assets to the release
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.check.outputs.artifact }}
          path: dist
      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@a56da0b891b3dc519c7ee3284aff1fad93cc8598 # v1.8.6
      - name: Generate Checksums
        working-directory: dist
        run: sha256sum * | tee sha256sums.txt
      - name: Add assets to release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v0.1.15
        with:
          files: dist/*
